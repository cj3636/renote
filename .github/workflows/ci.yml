name: CI

on:
  push:
  pull_request:

concurrency: ci-${{ github.ref }}

jobs:
  lint-analyse:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.1', '8.2', '8.3']
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: pdo, pdo_mysql, mbstring
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ matrix.php }}-${{ hashFiles('composer.lock') }}
          restore-keys: composer-
      - name: Composer validate
        run: composer validate --strict
      - name: Install deps
        run: composer install --no-interaction --prefer-dist
      - name: Static analysis
        run: vendor/bin/phpstan analyse
      - name: Style check
        run: vendor/bin/php-cs-fixer fix --dry-run --diff
      - name: Lint (syntax)
        run: find . -name '*.php' -print0 | xargs -0 -n1 php -l

  tests:
    runs-on: ubuntu-latest
    needs: lint-analyse
    services:
      redis:
        image: redis:7-alpine
        ports: ['6379:6379']
      mariadb:
        image: mariadb:10.5
        env:
          MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: yes
          MARIADB_DATABASE: pnotes
          MARIADB_USER: pnoteuser
          MARIADB_PASSWORD: ''
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo, pdo_mysql, mbstring
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-8.3-${{ hashFiles('composer.lock') }}
          restore-keys: composer-
      - name: Install deps
        run: composer install --no-interaction --prefer-dist
      - name: Wait for Redis
        run: for i in {1..20}; do (echo PING | nc 127.0.0.1 6379 | grep -q PONG) && break; sleep 1; done
      - name: Init schema
        run: php bin/migrate_categories.php || echo 'Migration step completed'
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: pnotes
          DB_USER: pnoteuser
          DB_PASS: ""
      - name: PHPUnit (with coverage)
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: pnotes
          DB_USER: pnoteuser
          DB_PASS: ""
          REDIS_CONNECTION: tcp
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
          APP_WRITE_BEHIND: false
          APP_REQUIRE_UUID: false
        run: vendor/bin/phpunit --colors=always