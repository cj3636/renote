# Renote Environment Configuration Example
# Copy to .env and adjust values. Empty values fall back to defaults in config.php.
# --- Value Safety (systemd EnvironmentFile) ---
# If a value contains '#', spaces, or leading/trailing whitespace, wrap it in double quotes:
#   VAR="my#value with spaces"
# Or escape only the hash: VAR=my\#value
# Do NOT put inline comments after quoted values (they become part of the value).
# Example unsafe without quotes: DB_PASS=p@ss#frag  (# would start a comment)
# Example safe:              DB_PASS="p@ss#frag"
# Example escaped (unquoted): DB_PASS=p@ss\#frag

# --- Application / Feature Flags ---
APP_DEBUG=false                    
# Enables debug/history UI; keep false in production
APP_WRITE_BEHIND=true              
# true: Redis stream + worker flush; false: synchronous DB writes (slower)
APP_WRITE_BEHIND_MODE=batch        
# batch | continuous (match your service/timer configuration)
APP_STREAM_MAXLEN=20000            
# Approximate max stream entries; lowering too far may drop unflushed events if worker is down
APP_CARD_MAX_LEN=262144            
# Maximum characters per card (returns text_too_long when exceeded)
APP_REQUIRE_UUID=false             # true enforces UUIDv4 IDs; false allows hex (16-64 chars)

# --- Redis ---
REDIS_CONNECTION=unix              # unix (preferred locally) | tcp
REDIS_SOCKET=/var/run/redis/redis.sock
REDIS_HOST=127.0.0.1               # Used when REDIS_CONNECTION=tcp
REDIS_PORT=6379
REDIS_USERNAME=
REDIS_PASSWORD=

# (Example with hash in value; uncomment and adjust)
# REDIS_PASSWORD="Str0ng#WithHash"

# --- MariaDB ---
DB_USE_SOCKET=true                 # Prefer sockets for latency; set false to use TCP with DB_HOST/DB_PORT
DB_SOCKET=/run/mysqld/mysqld.sock
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=pnotes
DB_USER=pnoteuser
DB_PASS=                           # Set e.g. DB_PASS="p@ss#word" if hash present

# TLS (only when DB_USE_SOCKET=false and TCP is in use)
DB_SSL_ENABLE=true                 # Disable only on trusted networks; otherwise provide CA/cert/key paths
DB_SSL_VERIFY=false                # Set true to verify server certificate against DB_SSL_CA
DB_SSL_CA=ssl/ca.crt
DB_SSL_CRT=ssl/client.crt
DB_SSL_KEY=ssl/client.key

# --- Worker Tuning ---
WORKER_BLOCK_MS=5000               # Blocking wait when worker runs continuously
WORKER_MAX_BATCH=1000              # Max events processed before committing; raise carefully to avoid long locks
WORKER_TRIM_EVERY=500              # Trim stream after this many processed events (approximate)
WORKER_MIN_OK_LAG=20               # Health: backlog below this is ok
WORKER_MIN_DEGRADED_LAG=200        # Health: backlog below this is degraded; otherwise backlog
BATCH_FLUSH_EXPECTED_INTERVAL=180  # Seconds between scheduled flushes when using systemd timer

# --- Pruning / Validation / Rate Limiting ---
PRUNE_EMPTY=true                   # If true, worker deletes nearly empty cards (< EMPTY_MINLEN) from DB
EMPTY_MINLEN=1                     # Minimum non-whitespace length to keep a card if PRUNE_EMPTY=true
RATE_LIMIT_WINDOW=60               # Seconds per rate limit window
RATE_LIMIT_MAX=300                 # Mutating requests per IP per window; set 0 to disable rate limiting

# --- Versioning / Snapshots ---
APP_VERSION_MAX_PER_CARD=25        # Keep the newest N snapshots per card (older trimmed)
APP_VERSION_MIN_INTERVAL_SEC=60    # Minimum seconds between auto snapshots during flush
APP_VERSION_MIN_SIZE_DELTA=20      # Minimum character delta since last snapshot to auto-capture
APP_VERSION_RETENTION_DAYS=0       # Age-based pruning; 0 disables (keep all until count limit trims)
